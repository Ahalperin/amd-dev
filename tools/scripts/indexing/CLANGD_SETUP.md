# Clangd Setup for AMD Development Workspace

This document describes the clangd C/C++ language server setup for the AMD development workspace.

## Overview

The workspace contains three C/C++ projects with clangd indexing configured:

1. **dn/rccl/** - RCCL library (CMake-based)
2. **dn/rccl-tests/** - RCCL test suite (CMake-based)
3. **dn/amd-anp/** - AMD ANP plugin (Makefile-based)

## File Structure

```
amd-dev/
â”œâ”€â”€ .clangd                              # Workspace-level clangd config
â”œâ”€â”€ regenerate-compile-commands.sh       # Helper script to regenerate compile DBs
â”œâ”€â”€ CLANGD_SETUP.md                      # This file
â””â”€â”€ dn/
    â”œâ”€â”€ rccl/
    â”‚   â”œâ”€â”€ .clangd                      # Project-specific config
    â”‚   â”œâ”€â”€ compile_commands.json        # Symlink to build/release/compile_commands.json
    â”‚   â””â”€â”€ build/release/
    â”‚       â””â”€â”€ compile_commands.json    # Generated by CMake
    â”œâ”€â”€ rccl-tests/
    â”‚   â”œâ”€â”€ .clangd                      # Project-specific config
    â”‚   â”œâ”€â”€ compile_commands.json        # Symlink to build/compile_commands.json
    â”‚   â””â”€â”€ build/
    â”‚       â””â”€â”€ compile_commands.json    # Generated by CMake
    â””â”€â”€ amd-anp/
        â”œâ”€â”€ .clangd                      # Project-specific config
        â””â”€â”€ compile_commands.json        # Generated by bear
```

## Initial Setup (Already Completed)

The following has already been set up for you:

1. âœ… Generated `compile_commands.json` for all three projects
2. âœ… Created `.clangd` configuration files
3. âœ… Created symlinks for easy access
4. âœ… Installed `bear` tool for Makefile projects

## Using Clangd

### In VS Code/Cursor

1. **Install the clangd extension** (if not already installed):
   - Search for "clangd" in the Extensions marketplace
   - Install the official "clangd" extension by LLVM

2. **Disable C/C++ IntelliSense** (if using Microsoft C/C++ extension):
   - Open Settings (Ctrl+,)
   - Search for "C_Cpp.intelliSenseEngine"
   - Set to "Disabled" or disable the C/C++ extension

3. **Restart clangd server**:
   - Open Command Palette (Ctrl+Shift+P)
   - Run: "clangd: Restart language server"

4. **Verify indexing**:
   - Open any C/C++ file from the projects
   - Wait for clangd to index (check status bar)
   - Test features like "Go to Definition" (F12) and auto-completion

### Features Available

With clangd properly configured, you get:

- âœ¨ **Accurate code completion** based on actual compilation flags
- ğŸ” **Go to definition/declaration** (F12)
- ğŸ” **Find all references** (Shift+F12)
- ğŸ’¡ **Code actions and refactoring**
- âš ï¸ **Real-time diagnostics** and warnings
- ğŸ“ **Hover documentation**
- ğŸ·ï¸ **Inlay hints** for parameter names and types
- ğŸ”§ **Automatic include fixes**

## Regenerating Compile Commands

When you modify build configurations or add new files, you may need to regenerate the `compile_commands.json` files.

### Regenerate All Projects

```bash
./regenerate-compile-commands.sh
```

### Regenerate Specific Project

```bash
./regenerate-compile-commands.sh rccl
./regenerate-compile-commands.sh rccl-tests
./regenerate-compile-commands.sh amd-anp
```

### Manual Regeneration

#### For RCCL (CMake)

```bash
cd dn/rccl/build/release
cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBUILD_TESTS=ON ../..
ln -sf $PWD/compile_commands.json ../../compile_commands.json
```

#### For RCCL Tests (CMake)

```bash
cd dn/rccl-tests/build
cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..
ln -sf $PWD/compile_commands.json ../compile_commands.json
```

#### For AMD ANP (Makefile with bear)

```bash
cd dn/amd-anp
# Touch source files to trigger rebuild
find src -name "*.cc" -exec touch {} \;
# Capture with bear
bear -- make RCCL_HOME=/home/amir/amd-dev/dn/rccl \
             RCCL_BUILD=/home/amir/amd-dev/dn/rccl/build/release
```

## Configuration Details

### Workspace-Level Config (.clangd)

The workspace-level `.clangd` file contains:
- Common compiler flags for ROCm/HIP development
- Flags to remove that clangd doesn't understand (like `--offload-arch`)
- Index and diagnostics configuration
- Inlay hints and hover settings

### Project-Level Configs (dn/*/. clangd)

Each project has its own `.clangd` file that points to the location of its `compile_commands.json`.

## Troubleshooting

### Clangd not finding symbols

1. Check that `compile_commands.json` exists and is not empty:
   ```bash
   ls -lh dn/rccl/compile_commands.json
   ls -lh dn/rccl-tests/compile_commands.json
   ls -lh dn/amd-anp/compile_commands.json
   ```

2. Regenerate compile commands:
   ```bash
   ./regenerate-compile-commands.sh
   ```

3. Restart clangd server in your IDE

### Clangd shows too many errors

- The workspace `.clangd` config removes some problematic HIP/ROCm flags
- Some warnings about offload architectures are expected and can be ignored
- Make sure the projects have been built at least once

### Bear not capturing commands for AMD ANP

1. Ensure bear is installed:
   ```bash
   which bear
   ```

2. Make sure RCCL is built first:
   ```bash
   cd dn/rccl/build/release && make
   ```

3. Touch source files to trigger rebuild before running bear

## Dependencies

- **clangd** - Language server (usually comes with LLVM/Clang)
- **bear** - Build EAR for capturing Makefile commands
- **CMake** - Build system for RCCL and RCCL Tests
- **ROCm/HIP** - AMD's GPU programming platform

## Additional Resources

- [clangd documentation](https://clangd.llvm.org/)
- [VS Code clangd extension](https://marketplace.visualstudio.com/items?itemName=llvm-vs-code-extensions.vscode-clangd)
- [bear documentation](https://github.com/rizsotto/Bear)
- [CMake compile_commands.json](https://cmake.org/cmake/help/latest/variable/CMAKE_EXPORT_COMPILE_COMMANDS.html)



